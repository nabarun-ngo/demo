name: Fetch Election Results (Log + Artifact)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes

jobs:
  fetch-results:
    runs-on: ubuntu-latest

    steps:
      # ================================
      # STEP 1: LOGIN
      # ================================
      - name: Login to ElectionRunner
        id: login
        env:
          LOGIN_URL: "https://electionrunner.com/api/auth/login"
          EMAIL: ${{ secrets.ELECTIONRUNNER_EMAIL }}
          PASSWORD: ${{ secrets.ELECTIONRUNNER_PASSWORD }}
        run: |
          echo "==============================="
          echo "‚û°Ô∏è STEP 1: Logging in..."
          echo "==============================="

          LOGIN_RESPONSE=$(curl -s "$LOGIN_URL" \
            -H "accept: application/json, text/plain, */*" \
            -H "content-type: application/json" \
            -H "origin: https://app.electionrunner.com" \
            -H "referer: https://app.electionrunner.com/" \
            -H "er-version: v3.9.6-8-gff28033" \
            --data-raw "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}")

          TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "‚ùå Login failed:"
            echo "$LOGIN_RESPONSE"
            exit 1
          fi

          echo "‚úÖ Login successful"

          # Export token
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      # ================================
      # STEP 2: FETCH RESULTS
      # ================================
      - name: Fetch Election Results
        id: fetch
        env:
          RESULTS_URL: "https://electionrunner.com/api/elections/452621/results"
          TOKEN: ${{ steps.login.outputs.token }}
        run: |
          echo "==============================="
          echo "‚û°Ô∏è STEP 2: Fetching election results..."
          echo "==============================="

          STATUS=$(curl -s -o results.json -w "%{http_code}" "$RESULTS_URL" \
            -H "accept: application/json, text/plain, */*" \
            -H "authorization: Bearer $TOKEN" \
            -H "origin: https://app.electionrunner.com" \
            -H "referer: https://app.electionrunner.com/" \
            -H "er-version: v3.9.6-8-gff28033")

          echo "HTTP Status: $STATUS"

          # Export status
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          # ----------------------------
          # If no changes
          # ----------------------------
          if [ "$STATUS" = "304" ]; then
            echo "‚ö†Ô∏è No changes (304 Not Modified)"
            exit 0
          fi

          # ----------------------------
          # If failure
          # ----------------------------
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Failed to fetch results"
            cat results.json
            exit 1
          fi

          # ----------------------------
          # Print JSON in logs
          # ----------------------------
          echo "==============================="
          echo "‚úÖ New Results Found!"
          echo "üìå JSON Response:"
          echo "==============================="

          cat results.json

      # ================================
      # STEP 3: UPLOAD ARTIFACT
      # ================================
      - name: Upload Results JSON Artifact
        if: steps.fetch.outputs.status != '200'
        uses: actions/upload-artifact@v4
        with:
          name: election-results-${{ github.run_id }}
          path: results.json
